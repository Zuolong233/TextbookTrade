<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­äºŒæ‰‹æ•™æç²¾å‡†äº¤æ˜“å¹³å°</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .app-container {
            min-height: 100vh;
        }
        
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .app-title {
            margin: 0;
            font-size: 24px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .nav-menu {
            display: flex;
            gap: 10px;
        }
        
        .app-main {
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .tab-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }
        
        .panel-title {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 600;
        }
        
        .panel-desc {
            margin: 0 0 25px 0;
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .app-footer {
            background: rgba(44, 62, 80, 0.9);
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .footer-content p {
            margin: 8px 0;
        }
        
        .feature-list {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 14px;
        }
        
        .feature-list span {
            opacity: 0.8;
        }
        
        .course-tree-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }
        
        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .book-card {
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        
        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 15px 0;
            }
            
            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .feature-list {
                flex-direction: column;
                gap: 8px;
            }
            
            .marketplace-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;
        const { ElMessage, ElMessageBox, ElTree } = ElementPlus;

        const CourseTree = {
            name: 'CourseTree',
            emits: ['course-select'],
            setup(props, { emit }) {
                const coursesData = ref({});
                const loading = ref(false);
                const API_BASE = 'http://localhost:5000/api';

                const loadCoursesTree = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get(`${API_BASE}/courses/tree`);
                        coursesData.value = response.data;
                    } catch (error) {
                        console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                    } finally {
                        loading.value = false;
                    }
                };

                const treeData = computed(() => {
                    const result = [];
                    for (const [major, semesters] of Object.entries(coursesData.value)) {
                        const majorNode = {
                            label: `ğŸ“ ${major}`,
                            children: []
                        };
                        for (const [semester, courses] of Object.entries(semesters)) {
                            const semesterNode = {
                                label: `ğŸ“… ${semester}`,
                                children: courses.map(course => ({
                                    label: `ğŸ“– ${course.name} (${course.code})`,
                                    courseData: course
                                }))
                            };
                            majorNode.children.push(semesterNode);
                        }
                        result.push(majorNode);
                    }
                    return result;
                });

                const handleNodeClick = (data) => {
                    if (data.courseData) {
                        emit('course-select', data.courseData);
                        ElMessage.success(`å·²é€‰æ‹©è¯¾ç¨‹ï¼š${data.courseData.name}`);
                    }
                };

                onMounted(() => {
                    loadCoursesTree();
                });

                return {
                    coursesData,
                    treeData,
                    loading,
                    handleNodeClick,
                    loadCoursesTree
                };
            },
            template: `
                <div class="course-tree-container">
                    <div style="margin-bottom: 20px;">
                        <el-button @click="loadCoursesTree" :loading="loading" size="small">
                            ğŸ”„ åˆ·æ–°æ•°æ®
                        </el-button>
                    </div>
                    <div v-loading="loading">
                        <el-tree
                            :data="treeData"
                            :props="{ children: 'children', label: 'label' }"
                            @node-click="handleNodeClick"
                            class="course-tree">
                        </el-tree>
                        <div v-if="Object.keys(coursesData).length === 0 && !loading" style="text-align: center; padding: 40px; color: #999;">
                            <p>ğŸ“š æš‚æ— è¯¾ç¨‹æ•°æ®</p>
                            <el-button @click="loadCoursesTree" type="primary">é‡æ–°åŠ è½½</el-button>
                        </div>
                    </div>
                </div>
            `
        };

        const ScanISBN = {
            name: 'ScanISBN',
            setup() {
                const isbnInput = ref('');
                const qrCodeUrl = ref('');
                const bookInfo = ref(null);
                const loading = ref(false);
                const API_BASE = 'http://localhost:5000/api';

                const scanISBN = async () => {
                    if (!isbnInput.value.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥ISBNå·');
                        return;
                    }

                    loading.value = true;
                    try {
                        const response = await axios.post(`${API_BASE}/search_book_by_isbn`, {
                            isbn: isbnInput.value.trim()
                        });
                        bookInfo.value = response.data;
                        ElMessage.success('ğŸ“š æ•™æä¿¡æ¯è¯†åˆ«æˆåŠŸï¼');
                    } catch (error) {
                        console.error('ISBNè¯†åˆ«å¤±è´¥:', error);
                        ElMessage.error('è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ISBNå·æˆ–ç½‘ç»œè¿æ¥');
                        bookInfo.value = null;
                    } finally {
                        loading.value = false;
                    }
                };

                const generateQR = async () => {
                    if (!isbnInput.value.trim()) {
                        ElMessage.warning('è¯·å…ˆè¾“å…¥ISBNå·');
                        return;
                    }

                    try {
                        const response = await axios.post(`${API_BASE}/generate_qr`, {
                            text: isbnInput.value.trim()
                        });
                        qrCodeUrl.value = response.data.qr_code;
                        ElMessage.success('ğŸ“± äºŒç»´ç ç”ŸæˆæˆåŠŸï¼');
                    } catch (error) {
                        console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', error);
                        ElMessage.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥');
                    }
                };

                return {
                    isbnInput,
                    qrCodeUrl,
                    bookInfo,
                    loading,
                    scanISBN,
                    generateQR
                };
            },
            template: `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px;">ğŸ“– ISBNå·è¯†åˆ«</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <el-input
                                v-model="isbnInput"
                                placeholder="è¯·è¾“å…¥13ä½ISBNå·ï¼Œå¦‚ï¼š9787111234567"
                                size="large"
                                style="flex: 1;">
                            </el-input>
                            <el-button @click="scanISBN" :loading="loading" type="primary" size="large">
                                ğŸ” è¯†åˆ«æ•™æ
                            </el-button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <el-button @click="generateQR" size="default" type="success">
                                ğŸ“± ç”ŸæˆäºŒç»´ç 
                            </el-button>
                            <el-button @click="isbnInput = ''; bookInfo = null; qrCodeUrl = ''" size="default">
                                ğŸ—‘ï¸ æ¸…ç©º
                            </el-button>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div v-if="bookInfo">
                            <h3 style="margin-bottom: 15px;">ğŸ“š æ•™æä¿¡æ¯</h3>
                            <el-card>
                                <div style="line-height: 1.8;">
                                    <p><strong>ğŸ“– ä¹¦å:</strong> {{ bookInfo.title }}</p>
                                    <p><strong>âœï¸ ä½œè€…:</strong> {{ bookInfo.author }}</p>
                                    <p><strong>ğŸ¢ å‡ºç‰ˆç¤¾:</strong> {{ bookInfo.publisher }}</p>
                                    <p><strong>ğŸ“… å‡ºç‰ˆå¹´ä»½:</strong> {{ bookInfo.year }}</p>
                                    <p><strong>ğŸ”¢ ISBN:</strong> {{ bookInfo.isbn }}</p>
                                </div>
                            </el-card>
                        </div>

                        <div v-if="qrCodeUrl">
                            <h3 style="margin-bottom: 15px;">ğŸ“± äºŒç»´ç </h3>
                            <el-card style="text-align: center;">
                                <img :src="qrCodeUrl" alt="äºŒç»´ç " style="max-width: 200px; border-radius: 8px;" />
                                <p style="margin-top: 10px; color: #666;">æ‰«æäºŒç»´ç åˆ†äº«æ•™æä¿¡æ¯</p>
                            </el-card>
                        </div>
                    </div>

                    <el-alert
                        title="ğŸ’¡ ä½¿ç”¨è¯´æ˜"
                        type="info"
                        :closable="false"
                        show-icon>
                        <p>â€¢ ISBNå·é€šå¸¸å°åœ¨å›¾ä¹¦èƒŒé¢æ¡å½¢ç ä¸Šæ–¹ï¼Œç”±13ä½æ•°å­—ç»„æˆ</p>
                        <p>â€¢ è¯†åˆ«åå¯è‡ªåŠ¨åŒ¹é…è¯¾ç¨‹ä¿¡æ¯ï¼Œæ–¹ä¾¿æŸ¥æ‰¾å¯¹åº”æ•™æ</p>
                        <p>â€¢ ç”Ÿæˆçš„äºŒç»´ç å¯åˆ†äº«ç»™å…¶ä»–åŒå­¦ï¼Œä¾¿äºå¿«é€ŸæŸ¥çœ‹æ•™æä¿¡æ¯</p>
                    </el-alert>
                </div>
            `
        };

        const BookMarketplace = {
            name: 'BookMarketplace',
            setup() {
                const listings = ref([]);
                const loading = ref(false);
                const API_BASE = 'http://localhost:5000/api';

                const loadListings = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get(`${API_BASE}/listings`);
                        listings.value = response.data;
                    } catch (error) {
                        console.error('åŠ è½½äºŒæ‰‹ä¹¦å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                    } finally {
                        loading.value = false;
                    }
                };

                const makeAppointment = async (listing) => {
                    try {
                        const { value: formData } = await ElMessageBox.prompt(
                            'è¯·å¡«å†™é¢„çº¦ä¿¡æ¯ï¼ˆæ ¼å¼ï¼šæ—¶é—´,åœ°ç‚¹,å¤‡æ³¨ï¼‰',
                            'ğŸ“… é¢„çº¦éªŒä¹¦',
                            {
                                confirmButtonText: 'ç¡®è®¤é¢„çº¦',
                                cancelButtonText: 'å–æ¶ˆ',
                                inputPlaceholder: 'ä¾‹å¦‚ï¼šæ˜å¤©ä¸‹åˆ2ç‚¹,å›¾ä¹¦é¦†ä¸€æ¥¼,å¾®ä¿¡è”ç³»'
                            }
                        );
                        
                        ElMessage.success(`ğŸ“… é¢„çº¦æˆåŠŸï¼å·²å‘å–å®¶ ${listing.seller} å‘é€é¢„çº¦ä¿¡æ¯`);
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('é¢„çº¦å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    }
                };

                onMounted(() => {
                    loadListings();
                });

                return {
                    listings,
                    loading,
                    loadListings,
                    makeAppointment
                };
            },
            template: `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                        <p style="margin: 0;">ğŸ›’ å‘ç° {{ listings.length }} æœ¬äºŒæ‰‹æ•™æï¼Œæ”¯æŒåœ¨çº¿é¢„çº¦éªŒä¹¦</p>
                        <el-button @click="loadListings" :loading="loading" size="default">
                            ğŸ”„ åˆ·æ–°åˆ—è¡¨
                        </el-button>
                    </div>

                    <div v-loading="loading" class="marketplace-grid">
                        <div v-for="listing in listings" :key="listing.id" class="book-card">
                            <h3 style="margin: 0 0 15px 0; color: #2c3e50;">ğŸ“š {{ listing.textbook.title }}</h3>
                            <div style="margin-bottom: 15px; line-height: 1.6;">
                                <p><strong>âœï¸ ä½œè€…:</strong> {{ listing.textbook.author }}</p>
                                <p><strong>ğŸ”¢ ISBN:</strong> {{ listing.textbook.isbn }}</p>
                                <p><strong>ğŸ‘¤ å–å®¶:</strong> {{ listing.seller }}</p>
                                <p><strong>ğŸ“Š æˆè‰²:</strong> <el-tag :type="listing.condition.includes('9') ? 'success' : 'warning'" size="small">{{ listing.condition }}</el-tag></p>
                            </div>
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                                <span style="font-size: 24px; font-weight: bold;">Â¥{{ listing.price.toFixed(2) }}</span>
                            </div>
                            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">{{ listing.description }}</p>
                            <div style="display: flex; gap: 8px;">
                                <el-button @click="makeAppointment(listing)" type="primary" size="default" style="flex: 1;">
                                    ğŸ“… é¢„çº¦éªŒä¹¦
                                </el-button>
                                <el-button type="success" size="default" style="flex: 1;">
                                    ğŸ’¬ è”ç³»å–å®¶
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <div v-if="listings.length === 0 && !loading" style="text-align: center; padding: 60px; color: #999;">
                        <p style="font-size: 48px; margin-bottom: 20px;">ğŸ“š</p>
                        <h3 style="margin-bottom: 15px;">æš‚æ— äºŒæ‰‹æ•™æ</h3>
                        <p style="margin-bottom: 25px;">ç›®å‰è¿˜æ²¡æœ‰å‘å¸ƒçš„äºŒæ‰‹æ•™æï¼Œå¿«å»å‘å¸ƒç¬¬ä¸€æœ¬å§ï¼</p>
                        <el-button type="primary" @click="loadListings">é‡æ–°åŠ è½½</el-button>
                    </div>
                </div>
            `
        };

        const PublishBook = {
            name: 'PublishBook',
            setup() {
                const form = reactive({
                    title: '',
                    author: '',
                    isbn: '',
                    price: '',
                    condition: '8æˆæ–°',
                    description: '',
                    contact_method: 'wechat',
                    contact_info: ''
                });

                const loading = ref(false);
                const API_BASE = 'http://localhost:5000/api';

                const publishBook = async () => {
                    if (!form.title.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥æ•™æåç§°');
                        return;
                    }
                    if (!form.price || form.price <= 0) {
                        ElMessage.warning('è¯·è¾“å…¥æœ‰æ•ˆä»·æ ¼');
                        return;
                    }
                    if (!form.contact_info.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥è”ç³»æ–¹å¼');
                        return;
                    }

                    loading.value = true;
                    try {
                        // è°ƒç”¨çœŸå®API
                        const response = await axios.post(`${API_BASE}/publish`, {
                            title: form.title,
                            author: form.author,
                            isbn: form.isbn,
                            price: parseFloat(form.price),
                            condition: form.condition,
                            description: form.description,
                            contact_method: form.contact_method,
                            contact_info: form.contact_info,
                            seller_name: 'å½“å‰ç”¨æˆ·',
                            seller_id: 1
                        });
                        
                        if (response.data.success) {
                            ElMessage.success('ğŸ“š æ•™æå‘å¸ƒæˆåŠŸï¼å·²åœ¨äºŒæ‰‹å¸‚åœºå±•ç¤º');
                            // é‡ç½®è¡¨å•
                            Object.keys(form).forEach(key => {
                                if (key === 'condition') {
                                    form[key] = '8æˆæ–°';
                                } else if (key === 'contact_method') {
                                    form[key] = 'wechat';
                                } else {
                                    form[key] = '';
                                }
                            });
                            
                            // æç¤ºç”¨æˆ·å¯ä»¥å»æŸ¥çœ‹
                            setTimeout(() => {
                                ElMessage.info('æ‚¨å¯ä»¥åˆ‡æ¢åˆ°"äºŒæ‰‹å¸‚åœº"é¡µé¢æŸ¥çœ‹åˆšå‘å¸ƒçš„æ•™æ');
                            }, 1500);
                        } else {
                            ElMessage.error(response.data.message || 'å‘å¸ƒå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('å‘å¸ƒå¤±è´¥:', error);
                        ElMessage.error('å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        loading.value = false;
                    }
                };

                return {
                    form,
                    loading,
                    publishBook
                };
            },
            template: `
                <div class="form-container">
                    <el-form :model="form" label-width="100px" size="default">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“š æ•™æåŸºæœ¬ä¿¡æ¯</h3>
                        
                        <el-form-item label="ğŸ“– æ•™æåç§°" required>
                            <el-input v-model="form.title" placeholder="è¯·è¾“å…¥æ•™æåç§°" />
                        </el-form-item>

                        <el-form-item label="âœï¸ ä½œè€…">
                            <el-input v-model="form.author" placeholder="è¯·è¾“å…¥ä½œè€…å§“å" />
                        </el-form-item>

                        <el-form-item label="ğŸ”¢ ISBNå·">
                            <el-input v-model="form.isbn" placeholder="å¦‚ï¼š9787111234567" />
                        </el-form-item>

                        <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">ğŸ’° äº¤æ˜“ä¿¡æ¯</h3>

                        <el-form-item label="ğŸ’µ å”®ä»·" required>
                            <el-input v-model="form.price" type="number" placeholder="è¯·è¾“å…¥ä»·æ ¼" min="0">
                                <template #suffix>å…ƒ</template>
                            </el-input>
                        </el-form-item>

                        <el-form-item label="ğŸ“Š æˆè‰²" required>
                            <el-select v-model="form.condition" style="width: 100%;">
                                <el-option label="å…¨æ–°" value="å…¨æ–°"></el-option>
                                <el-option label="9æˆæ–°" value="9æˆæ–°"></el-option>
                                <el-option label="8æˆæ–°" value="8æˆæ–°"></el-option>
                                <el-option label="7æˆæ–°" value="7æˆæ–°"></el-option>
                            </el-select>
                        </el-form-item>

                        <el-form-item label="ğŸ“ æè¿°">
                            <el-input v-model="form.description" type="textarea" :rows="4" placeholder="è¯·æè¿°æ•™æçš„å…·ä½“æƒ…å†µ" />
                        </el-form-item>

                        <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">ğŸ“ è”ç³»ä¿¡æ¯</h3>

                        <el-form-item label="ğŸ“± è”ç³»æ–¹å¼" required>
                            <el-select v-model="form.contact_method" style="width: 100%;">
                                <el-option label="å¾®ä¿¡" value="wechat"></el-option>
                                <el-option label="QQ" value="qq"></el-option>
                                <el-option label="æ‰‹æœºå·" value="phone"></el-option>
                                <el-option label="é‚®ç®±" value="email"></el-option>
                            </el-select>
                        </el-form-item>

                        <el-form-item label="ğŸ“‹ è”ç³»è´¦å·" required>
                            <el-input v-model="form.contact_info" :placeholder="form.contact_method === 'wechat' ? 'è¯·è¾“å…¥å¾®ä¿¡å·' : form.contact_method === 'qq' ? 'è¯·è¾“å…¥QQå·' : form.contact_method === 'phone' ? 'è¯·è¾“å…¥æ‰‹æœºå·' : 'è¯·è¾“å…¥é‚®ç®±åœ°å€'" />
                        </el-form-item>

                        <div style="text-align: center; margin-top: 30px;">
                            <el-button @click="publishBook" type="primary" size="large" :loading="loading" style="min-width: 150px;">
                                <span v-if="!loading">ğŸš€ å‘å¸ƒåˆ°äºŒæ‰‹å¸‚åœº</span>
                                <span v-else>å‘å¸ƒä¸­...</span>
                            </el-button>
                        </div>
                    </el-form>
                </div>
            `
        };

        const UserRegister = {
            name: 'UserRegister',
            setup() {
                const form = reactive({
                    username: '',
                    email: '',
                    password: '',
                    major: '',
                    grade: ''
                });

                const loading = ref(false);
                const API_BASE = 'http://localhost:5000/api';

                const registerUser = async () => {
                    if (!form.username.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥ç”¨æˆ·å');
                        return;
                    }
                    if (!form.email.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥é‚®ç®±');
                        return;
                    }
                    if (!form.password) {
                        ElMessage.warning('è¯·è¾“å…¥å¯†ç ');
                        return;
                    }

                    loading.value = true;
                    try {
                        const response = await axios.post(`${API_BASE}/register`, {
                            username: form.username,
                            email: form.email,
                            password: form.password,
                            major: form.major,
                            grade: form.grade
                        });
                        
                        if (response.data.success) {
                            ElMessage.success('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿åŠ å…¥æ ¡å›­äºŒæ‰‹æ•™æäº¤æ˜“å¹³å°');
                            Object.keys(form).forEach(key => {
                                form[key] = '';
                            });
                            
                            // æ³¨å†ŒæˆåŠŸåæç¤ºç”¨æˆ·å»ç™»å½•
                            setTimeout(() => {
                                ElMessage.info('è¯·å‰å¾€ç™»å½•é¡µé¢ç™»å½•æ‚¨çš„è´¦å·');
                            }, 1500);
                        } else {
                            ElMessage.error(response.data.message || 'æ³¨å†Œå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('æ³¨å†Œå¤±è´¥:', error);
                        ElMessage.error('æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        loading.value = false;
                    }
                };

                return {
                    form,
                    loading,
                    registerUser
                };
            },
            template: `
                <div class="form-container">
                    <el-form :model="form" label-width="80px" size="default">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</h3>
                        
                        <el-form-item label="ğŸ‘¤ ç”¨æˆ·å" required>
                            <el-input v-model="form.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
                        </el-form-item>

                        <el-form-item label="ğŸ“§ é‚®ç®±" required>
                            <el-input v-model="form.email" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" />
                        </el-form-item>

                        <el-form-item label="ğŸ”’ å¯†ç " required>
                            <el-input v-model="form.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " show-password />
                        </el-form-item>

                        <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">ğŸ“ å­¦ç±ä¿¡æ¯</h3>

                        <el-form-item label="ğŸ“š ä¸“ä¸š">
                            <el-input v-model="form.major" placeholder="è¯·è¾“å…¥ä¸“ä¸š" />
                        </el-form-item>

                        <el-form-item label="ğŸ“… å¹´çº§">
                            <el-select v-model="form.grade" placeholder="è¯·é€‰æ‹©å¹´çº§" style="width: 100%;">
                                <el-option label="å¤§ä¸€" value="å¤§ä¸€"></el-option>
                                <el-option label="å¤§äºŒ" value="å¤§äºŒ"></el-option>
                                <el-option label="å¤§ä¸‰" value="å¤§ä¸‰"></el-option>
                                <el-option label="å¤§å››" value="å¤§å››"></el-option>
                                <el-option label="ç ”ç©¶ç”Ÿ" value="ç ”ç©¶ç”Ÿ"></el-option>
                            </el-select>
                        </el-form-item>

                        <div style="text-align: center; margin-top: 30px;">
                            <el-button @click="registerUser" type="primary" size="large" :loading="loading" style="min-width: 150px;">
                                <span v-if="!loading">ğŸš€ ç«‹å³æ³¨å†Œ</span>
                                <span v-else>æ³¨å†Œä¸­...</span>
                            </el-button>
                        </div>
                    </el-form>
                </div>
            `
        };

        const UserLogin = {
            name: 'UserLogin',
            setup() {
                const form = reactive({
                    username: '',
                    password: ''
                });

                const loading = ref(false);
                const API_BASE = 'http://localhost:5000/api';

                const loginUser = async () => {
                    if (!form.username.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±');
                        return;
                    }
                    if (!form.password.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥å¯†ç ');
                        return;
                    }

                    loading.value = true;
                    try {
                        const response = await axios.post(`${API_BASE}/login`, {
                            username: form.username,
                            password: form.password
                        });
                        
                        if (response.data.success) {
                            localStorage.setItem('user', JSON.stringify(response.data.user));
                            localStorage.setItem('token', response.data.token);
                            
                            ElMessage.success(`ğŸ‰ æ¬¢è¿å›æ¥ï¼Œ${response.data.user.username}ï¼`);
                            
                            // è§¦å‘ç™»å½•æˆåŠŸäº‹ä»¶
                            window.dispatchEvent(new CustomEvent('userLoggedIn', {
                                detail: response.data.user
                            }));
                            
                            form.username = '';
                            form.password = '';
                        } else {
                            ElMessage.error(response.data.message || 'ç™»å½•å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ç™»å½•å¤±è´¥:', error);
                        ElMessage.error('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        loading.value = false;
                    }
                };

                const quickLogin = () => {
                    form.username = 'demo_user';
                    form.password = '123456';
                    ElMessage.info('å·²å¡«å…¥æ¼”ç¤ºè´¦å·ï¼Œç‚¹å‡»ç™»å½•å³å¯ä½“éªŒ');
                };

                return {
                    form,
                    loading,
                    loginUser,
                    quickLogin
                };
            },
            template: `
                <div class="form-container">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">ğŸ” ç”¨æˆ·ç™»å½•</h2>
                        <p style="color: #666;">ç™»å½•åå¯å‘å¸ƒå’Œè´­ä¹°äºŒæ‰‹æ•™æ</p>
                    </div>

                    <el-form :model="form" label-width="80px" size="default">
                        <el-form-item label="è´¦å·" required>
                            <el-input v-model="form.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" />
                        </el-form-item>

                        <el-form-item label="å¯†ç " required>
                            <el-input v-model="form.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " show-password />
                        </el-form-item>

                        <div style="text-align: center; margin-top: 30px;">
                            <el-button @click="loginUser" type="primary" size="large" :loading="loading" style="min-width: 150px; margin-bottom: 15px;">
                                <span v-if="!loading">ğŸš€ ç«‹å³ç™»å½•</span>
                                <span v-else>ç™»å½•ä¸­...</span>
                            </el-button>
                            <br>
                            <el-button @click="quickLogin" type="success" size="default" plain>
                                âš¡ æ¼”ç¤ºç™»å½•
                            </el-button>
                        </div>

                        <div style="text-align: center; margin-top: 20px; color: #666;">
                            <span>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                            <a href="#" style="color: #409eff;">ç«‹å³æ³¨å†Œ</a>
                        </div>
                    </el-form>
                </div>
            `
        };

        const App = {
            name: 'App',
            components: {
                CourseTree,
                ScanISBN,
                BookMarketplace,
                PublishBook,
                UserRegister,
                UserLogin
            },
            setup() {
                const activeTab = ref('home');
                const selectedCourse = ref(null);
                const currentUser = ref(null);

                const checkLoginStatus = () => {
                    const user = localStorage.getItem('user');
                    const token = localStorage.getItem('token');
                    if (user && token) {
                        currentUser.value = JSON.parse(user);
                    }
                };

                const switchTab = (tab) => {
                    activeTab.value = tab;
                };

                const onCourseSelect = (course) => {
                    selectedCourse.value = course;
                    activeTab.value = 'textbooks';
                };

                const logout = () => {
                    localStorage.removeItem('user');
                    localStorage.removeItem('token');
                    currentUser.value = null;
                    ElMessage.success('å·²é€€å‡ºç™»å½•');
                    activeTab.value = 'home';
                };

                onMounted(() => {
                    checkLoginStatus();
                    
                    window.addEventListener('userLoggedIn', (event) => {
                        currentUser.value = event.detail;
                    });
                });

                return {
                    activeTab,
                    selectedCourse,
                    currentUser,
                    switchTab,
                    onCourseSelect,
                    logout
                };
            },
            template: `
                <div class="app-container">
                    <el-container>
                        <el-header class="app-header">
                            <div class="header-content">
                                <h1 class="app-title">ğŸ“š æ ¡å›­äºŒæ‰‹æ•™æç²¾å‡†äº¤æ˜“å¹³å°</h1>
                                <nav class="nav-menu">
                                    <el-button @click="switchTab('home')" :type="activeTab === 'home' ? 'primary' : 'default'">ğŸ  é¦–é¡µ</el-button>
                                    <el-button @click="switchTab('scan')" :type="activeTab === 'scan' ? 'primary' : 'default'">ğŸ“± æ‰«ç è¯†åˆ«</el-button>
                                    <el-button @click="switchTab('marketplace')" :type="activeTab === 'marketplace' ? 'primary' : 'default'">ğŸ›’ äºŒæ‰‹å¸‚åœº</el-button>
                                    <el-button @click="switchTab('publish')" :type="activeTab === 'publish' ? 'primary' : 'default'">âœï¸ å‘å¸ƒ</el-button>
                                </nav>
                                
                                <!-- ç”¨æˆ·çŠ¶æ€åŒºåŸŸ -->
                                <div class="user-area" style="display: flex; align-items: center; gap: 10px;">
                                    <div v-if="currentUser" style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: #2c3e50; font-weight: 500;">ğŸ‘‹ {{ currentUser.username }}</span>
                                        <el-button @click="logout" type="danger" size="small" plain>é€€å‡º</el-button>
                                    </div>
                                    <div v-else style="display: flex; gap: 8px;">
                                        <el-button @click="switchTab('login')" :type="activeTab === 'login' ? 'primary' : 'success'">ğŸ” ç™»å½•</el-button>
                                        <el-button @click="switchTab('register')" :type="activeTab === 'register' ? 'primary' : 'default'">ğŸ‘¤ æ³¨å†Œ</el-button>
                                    </div>
                                </div>
                            </div>
                        </el-header>

                        <el-main class="app-main">
                            <div v-if="activeTab === 'home'" class="tab-panel">
                                <h2 class="panel-title">ğŸ“– è¯¾ç¨‹åˆ†ç±»æµè§ˆ</h2>
                                <p class="panel-desc">æŒ‰ä¸“ä¸šå’Œå­¦æœŸåˆ†ç±»æŸ¥çœ‹è¯¾ç¨‹ï¼Œç‚¹å‡»è¯¾ç¨‹å¯æŸ¥çœ‹ç›¸å…³æ•™æ</p>
                                <CourseTree @course-select="onCourseSelect" />
                            </div>

                            <div v-if="activeTab === 'textbooks'" class="tab-panel">
                                <h2 class="panel-title">ğŸ“š {{ selectedCourse?.name || 'è¯¾ç¨‹' }} - æ•™æåˆ—è¡¨</h2>
                                <div v-if="selectedCourse" style="text-align: center; padding: 40px;">
                                    <p style="font-size: 18px; color: #666; margin-bottom: 20px;">
                                        è¯¥è¯¾ç¨‹çš„æ•™æä¿¡æ¯æ­£åœ¨æ•´ç†ä¸­...
                                    </p>
                                    <el-button @click="switchTab('marketplace')" type="primary">
                                        ğŸ›’ ç›´æ¥æŸ¥çœ‹äºŒæ‰‹å¸‚åœº
                                    </el-button>
                                </div>
                            </div>

                            <div v-if="activeTab === 'scan'" class="tab-panel">
                                <h2 class="panel-title">ğŸ“± ISBNæ‰«ç è¯†åˆ«</h2>
                                <p class="panel-desc">æ‰«ææˆ–è¾“å…¥æ•™æISBNå·ï¼Œè‡ªåŠ¨åŒ¹é…è¯¾ç¨‹ä¿¡æ¯</p>
                                <ScanISBN />
                            </div>

                            <div v-if="activeTab === 'marketplace'" class="tab-panel">
                                <h2 class="panel-title">ğŸ›’ äºŒæ‰‹æ•™æå¸‚åœº</h2>
                                <p class="panel-desc">æµè§ˆå’Œè´­ä¹°äºŒæ‰‹æ•™æï¼Œæ”¯æŒåœ¨çº¿é¢„çº¦éªŒä¹¦</p>
                                <BookMarketplace />
                            </div>

                            <div v-if="activeTab === 'publish'" class="tab-panel">
                                <h2 class="panel-title">âœï¸ å‘å¸ƒäºŒæ‰‹æ•™æ</h2>
                                <p class="panel-desc">å‘å¸ƒä½ çš„äºŒæ‰‹æ•™æä¿¡æ¯</p>
                                <PublishBook />
                            </div>

                            <div v-if="activeTab === 'login'" class="tab-panel">
                                <h2 class="panel-title">ğŸ” ç”¨æˆ·ç™»å½•</h2>
                                <p class="panel-desc">ç™»å½•åå¯å‘å¸ƒå’Œè´­ä¹°äºŒæ‰‹æ•™æ</p>
                                <UserLogin />
                            </div>

                            <div v-if="activeTab === 'register'" class="tab-panel">
                                <h2 class="panel-title">ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ</h2>
                                <p class="panel-desc">æ³¨å†Œè´¦å·ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½</p>
                                <UserRegister />
                            </div>
                        </el-main>

                        <el-footer class="app-footer">
                            <div class="footer-content">
                                <p>ğŸ“ æ ¡å›­äºŒæ‰‹æ•™æç²¾å‡†äº¤æ˜“å¹³å° - è®©æ•™ææµè½¬æ›´ç®€å•</p>
                                <p class="feature-list">
                                    <span>ğŸ“± æ‰«ç è¯†åˆ«</span>
                                    <span>ğŸŒ³ è¯¾ç¨‹æ ‘å±•ç¤º</span>
                                    <span>ğŸ“… åœ¨çº¿é¢„çº¦éªŒä¹¦</span>
                                </p>
                            </div>
                        </el-footer>
                    </el-container>
                </div>
            `
        };

        const app = createApp(App);
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>